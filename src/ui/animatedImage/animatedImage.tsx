'use client';

import { FC, useEffect, useRef, useState } from 'react';
import classNames from 'classnames';
import gsap from 'gsap';
import { ScrollTrigger } from 'gsap/ScrollTrigger';

import styles from './animatedImage.module.scss';
import { AnimatedImageProps } from './animatedImage.types';

gsap.registerPlugin(ScrollTrigger);

const AnimatedImage: FC<AnimatedImageProps> = ({ className }) => {
  const rootClassName = classNames(styles.root, className);
  const svgRef = useRef<SVGSVGElement>(null);
  const [isInView, setIsInView] = useState(false);

  useEffect(() => {
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          setIsInView(true);
          observer.disconnect(); // Отключаем observer после первого появления
        }
      },
      {
        threshold: 0.1 // Триггер когда хотя бы 10% компонента видно
      }
    );

    if (svgRef.current) {
      observer.observe(svgRef.current);
    }

    return () => observer.disconnect();
  }, []);

  useEffect(() => {
    const svgElement = svgRef.current;
    if (!svgElement || !isInView) {
      return;
    }

    // Создаем общий таймлайн для анимаций
    const timeline = gsap.timeline({
      scrollTrigger: {
        trigger: svgElement,
        start: 'top 75%',
        toggleActions: 'play none none none',
      },
    });

    // Выбираем все <path> элементы с атрибутом stroke и без него
    const paths = svgElement.querySelectorAll('path');
    if (paths && paths.length > 0) {
      // Применяем GSAP-анимацию ко всем <path> через таймлайн
      paths.forEach((path) => {
        const isStroke = path.hasAttribute('stroke');
        const fromSettings = isStroke
          ? { strokeDasharray: '0 1000', strokeDashoffset: 1000 }
          : { opacity: 0 };
        const toSettings = isStroke
          ? { strokeDasharray: '5000 5000', strokeDashoffset: 0 }
          : { opacity: 1 };

        timeline.fromTo(
          path,
          fromSettings,
          {
            ...toSettings,
            duration: isStroke ? 5 : 5, // Скорость анимации
            ease: 'power2.in',
            stagger: 0.3, // Задержка между анимацией каждого <path>
          },
          '<' // Начинаем каждую анимацию одновременно для всех <path>
        );
      });
    } else {
      console.error('No <path> elements found for animation.');
    }

    // Выбир��ем все <circle> элементы
    const circles = svgElement.querySelectorAll('circle');
    if (circles && circles.length > 0) {
      // Добавляем анимацию для <circle> элементов после завершения анимации <path>
      timeline.fromTo(
        circles,
        { scale: 0, transformOrigin: 'center' },
        {
          scale: 1,
          duration: 1,
          ease: 'elastic.out(1, 0.5)',
          stagger: 0.2, // Задержка между анимацией каждого <circle>
        }
      );
    } else {
      console.error('No <circle> elements found for animation.');
    }
  }, [isInView]);

  return (
    <div className={rootClassName}>
      <svg
        ref={svgRef}
        width="1200"
        height="820"
        viewBox="0 0 1200 820"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        {/* Пример path-элементов */}
        <path d="M1372.5 1013C1369.72 811.548 926.328 563.368 572.123 568.248C217.918 573.128 -235.775 842.548 -233 1044" stroke="#F0F3F7" stroke-opacity="0.3" />
        <path
          d="M87.88 651H86.584V638.166H87.88V651ZM92.2548 644.574C92.2548 649.524 95.2248 649.992 98.1948 649.992C99.3648 649.992 100.769 649.938 102.119 649.686V645.222H96.8448V643.962H103.415V650.658C101.417 651.036 99.7968 651.234 98.0328 651.234C94.5768 651.234 90.9768 650.478 90.9768 644.574C90.9768 638.67 94.5588 637.914 98.0868 637.914C99.7068 637.914 101.399 638.076 103.055 638.31L102.947 639.552C101.381 639.246 99.5808 639.156 98.2308 639.156C95.2248 639.156 92.2548 639.606 92.2548 644.574ZM118.864 651L117.334 648.03H109L107.488 651H106.048L112.636 638.166H113.716L120.304 651H118.864ZM113.176 639.858L109.576 646.896H116.758L113.176 639.858ZM136.976 651H135.716V640.704L130.514 648.426H129.416L124.214 640.704V651H122.918V638.166H124.052L129.956 647.004L135.878 638.166H136.976V651ZM141.441 651H140.145V638.166H141.441V651ZM156.561 651H155.535L145.905 640.326V651H144.609V638.166H145.671L155.283 648.858V638.166H156.561V651ZM160.933 644.574C160.933 649.524 163.903 649.992 166.873 649.992C168.043 649.992 169.447 649.938 170.797 649.686V645.222H165.523V643.962H172.093V650.658C170.095 651.036 168.475 651.234 166.711 651.234C163.255 651.234 159.655 650.478 159.655 644.574C159.655 638.67 163.237 637.914 166.765 637.914C168.385 637.914 170.077 638.076 171.733 638.31L171.625 639.552C170.059 639.246 168.259 639.156 166.909 639.156C163.903 639.156 160.933 639.606 160.933 644.574Z"
          fill="#F0F3F7"
          fillOpacity="0.7"
        />
        <path d="M982.598 651L978.062 638.166H979.394L983.12 649.038L987.332 638.166H988.394L992.624 649.038L996.314 638.166H997.682L993.182 651H992.102L987.854 640.11L983.66 651H982.598ZM1006.37 651.252C1005.47 651.252 1004.61 651.15 1003.8 650.946C1002.99 650.742 1002.29 650.388 1001.67 649.884C1001.06 649.368 1000.58 648.678 1000.22 647.814C999.856 646.95 999.676 645.864 999.676 644.556C999.676 643.284 999.844 642.228 1000.18 641.388C1000.53 640.536 1001 639.852 1001.58 639.336C1002.18 638.82 1002.89 638.454 1003.69 638.238C1004.51 638.022 1005.38 637.914 1006.32 637.914C1007.22 637.914 1008.07 638.016 1008.87 638.22C1009.69 638.424 1010.4 638.784 1011.02 639.3C1011.63 639.804 1012.11 640.488 1012.47 641.352C1012.83 642.216 1013.01 643.302 1013.01 644.61C1013.01 645.882 1012.84 646.944 1012.49 647.796C1012.16 648.648 1011.69 649.332 1011.09 649.848C1010.5 650.352 1009.8 650.712 1008.98 650.928C1008.18 651.144 1007.31 651.252 1006.37 651.252ZM1006.37 649.992C1007.13 649.992 1007.83 649.908 1008.48 649.74C1009.13 649.56 1009.69 649.266 1010.17 648.858C1010.65 648.438 1011.03 647.886 1011.3 647.202C1011.58 646.506 1011.72 645.642 1011.72 644.61C1011.72 643.542 1011.57 642.66 1011.29 641.964C1011 641.268 1010.61 640.716 1010.12 640.308C1009.62 639.888 1009.05 639.594 1008.39 639.426C1007.74 639.258 1007.05 639.174 1006.32 639.174C1005.56 639.174 1004.86 639.264 1004.21 639.444C1003.56 639.612 1003 639.906 1002.52 640.326C1002.04 640.734 1001.66 641.286 1001.39 641.982C1001.11 642.666 1000.97 643.524 1000.97 644.556C1000.97 645.624 1001.12 646.506 1001.4 647.202C1001.69 647.898 1002.08 648.456 1002.57 648.876C1003.07 649.284 1003.64 649.572 1004.28 649.74C1004.94 649.908 1005.64 649.992 1006.37 649.992ZM1016.25 651V638.166C1016.81 638.13 1017.37 638.1 1017.95 638.076C1018.52 638.052 1019.07 638.034 1019.6 638.022C1020.13 637.998 1020.62 637.98 1021.08 637.968C1021.53 637.956 1021.93 637.95 1022.27 637.95C1023.08 637.95 1023.83 637.998 1024.52 638.094C1025.21 638.19 1025.81 638.388 1026.32 638.688C1026.82 638.988 1027.21 639.42 1027.49 639.984C1027.77 640.536 1027.92 641.28 1027.92 642.216C1027.92 642.888 1027.84 643.458 1027.68 643.926C1027.54 644.394 1027.33 644.79 1027.05 645.114C1026.79 645.438 1026.46 645.696 1026.06 645.888C1025.68 646.068 1025.25 646.2 1024.79 646.284L1027.65 650.91L1027.63 651.018L1026.33 651.18L1023.4 646.464C1023.22 646.476 1023.03 646.482 1022.84 646.482C1022.66 646.482 1022.47 646.482 1022.27 646.482C1021.73 646.482 1021.03 646.47 1020.18 646.446C1019.34 646.422 1018.46 646.386 1017.55 646.338V651H1016.25ZM1026.62 642.216C1026.62 641.556 1026.51 641.028 1026.28 640.632C1026.06 640.224 1025.76 639.918 1025.36 639.714C1024.98 639.498 1024.52 639.36 1023.98 639.3C1023.44 639.228 1022.85 639.192 1022.23 639.192C1021.7 639.192 1021.02 639.21 1020.18 639.246C1019.35 639.27 1018.47 639.306 1017.55 639.354V645.096C1018.47 645.144 1019.35 645.18 1020.18 645.204C1021.02 645.228 1021.7 645.24 1022.23 645.24C1022.85 645.24 1023.44 645.21 1023.98 645.15C1024.52 645.078 1024.98 644.94 1025.36 644.736C1025.76 644.52 1026.06 644.214 1026.28 643.818C1026.51 643.422 1026.62 642.888 1026.62 642.216ZM1041.18 651H1030.54V638.166H1031.84V649.758H1041.29L1041.18 651ZM1044.31 651V638.166H1044.33C1044.79 638.13 1045.27 638.1 1045.75 638.076C1046.24 638.04 1046.72 638.01 1047.19 637.986C1047.66 637.962 1048.11 637.944 1048.54 637.932C1048.97 637.92 1049.36 637.914 1049.71 637.914C1050.61 637.914 1051.48 637.986 1052.32 638.13C1053.17 638.262 1053.92 638.556 1054.57 639.012C1055.23 639.468 1055.76 640.14 1056.15 641.028C1056.56 641.904 1056.76 643.086 1056.76 644.574C1056.76 646.05 1056.56 647.226 1056.15 648.102C1055.76 648.966 1055.23 649.626 1054.57 650.082C1053.92 650.538 1053.17 650.838 1052.32 650.982C1051.47 651.114 1050.59 651.18 1049.69 651.18C1049.34 651.18 1048.95 651.174 1048.52 651.162C1048.1 651.162 1047.66 651.15 1047.19 651.126C1046.72 651.114 1046.24 651.096 1045.75 651.072C1045.27 651.048 1044.79 651.024 1044.33 651H1044.31ZM1049.62 639.156C1049.11 639.156 1048.5 639.168 1047.78 639.192C1047.07 639.216 1046.35 639.258 1045.6 639.318V649.83C1045.98 649.854 1046.35 649.872 1046.72 649.884C1047.09 649.896 1047.45 649.908 1047.78 649.92C1048.13 649.932 1048.45 649.938 1048.74 649.938C1049.04 649.938 1049.29 649.938 1049.51 649.938C1050.29 649.938 1051.04 649.89 1051.76 649.794C1052.48 649.698 1053.12 649.47 1053.67 649.11C1054.22 648.75 1054.66 648.216 1054.98 647.508C1055.32 646.788 1055.49 645.81 1055.49 644.574C1055.49 643.326 1055.32 642.342 1054.98 641.622C1054.66 640.902 1054.23 640.362 1053.69 640.002C1053.15 639.63 1052.52 639.396 1051.81 639.3C1051.11 639.204 1050.37 639.156 1049.62 639.156ZM1063.39 651L1058.85 638.166H1060.18L1063.91 649.038L1068.12 638.166H1069.18L1073.41 649.038L1077.1 638.166H1078.47L1073.97 651H1072.89L1068.64 640.11L1064.45 651H1063.39ZM1081.12 651V638.166H1082.41V651H1081.12ZM1085.58 651V638.166H1085.6C1086.07 638.13 1086.54 638.1 1087.02 638.076C1087.51 638.04 1087.99 638.01 1088.46 637.986C1088.93 637.962 1089.38 637.944 1089.81 637.932C1090.24 637.92 1090.63 637.914 1090.98 637.914C1091.88 637.914 1092.75 637.986 1093.59 638.13C1094.44 638.262 1095.19 638.556 1095.84 639.012C1096.5 639.468 1097.03 640.14 1097.43 641.028C1097.83 641.904 1098.04 643.086 1098.04 644.574C1098.04 646.05 1097.83 647.226 1097.43 648.102C1097.03 648.966 1096.5 649.626 1095.84 650.082C1095.19 650.538 1094.44 650.838 1093.59 650.982C1092.74 651.114 1091.86 651.18 1090.96 651.18C1090.62 651.18 1090.23 651.174 1089.79 651.162C1089.37 651.162 1088.93 651.15 1088.46 651.126C1087.99 651.114 1087.51 651.096 1087.02 651.072C1086.54 651.048 1086.07 651.024 1085.6 651H1085.58ZM1090.89 639.156C1090.39 639.156 1089.78 639.168 1089.06 639.192C1088.35 639.216 1087.62 639.258 1086.88 639.318V649.83C1087.25 649.854 1087.62 649.872 1087.99 649.884C1088.37 649.896 1088.72 649.908 1089.06 649.92C1089.4 649.932 1089.72 649.938 1090.01 649.938C1090.31 649.938 1090.57 649.938 1090.78 649.938C1091.56 649.938 1092.31 649.89 1093.03 649.794C1093.75 649.698 1094.39 649.47 1094.94 649.11C1095.49 648.75 1095.93 648.216 1096.26 647.508C1096.59 646.788 1096.76 645.81 1096.76 644.574C1096.76 643.326 1096.59 642.342 1096.26 641.622C1095.93 640.902 1095.5 640.362 1094.96 640.002C1094.42 639.63 1093.8 639.396 1093.09 639.3C1092.38 639.204 1091.65 639.156 1090.89 639.156ZM1101.19 651V638.166H1111.94L1111.83 639.426H1102.49V643.962H1110.86L1110.79 645.222H1102.49V649.758H1111.94L1111.83 651H1101.19Z" fill="#F0F3F7" fill-opacity="0.7" />
        <path d="M586.804 -83.9758C763.742 -86.4134 940.864 -0.954503 1074.47 136.712C1208.08 274.375 1298.13 464.21 1300.97 670.466C1306.66 1082.98 961.315 1405.01 607.384 1409.89C253.465 1414.76 -94.3872 1094.73 -100.07 682.207C-105.754 269.661 232.901 -79.1003 586.804 -83.9758Z" stroke="#F0F3F7" stroke-opacity="0.3" />
        <path d="M587.334 -46.8399C755.78 -49.1605 924.403 32.1971 1051.6 163.259C1178.8 294.318 1264.53 475.045 1267.24 671.404C1272.65 1064.13 943.875 1370.71 606.926 1375.35C269.99 1379.99 -61.1725 1075.32 -66.583 682.582C-71.9937 289.828 250.414 -42.1984 587.334 -46.8399Z" stroke="#F0F3F7" stroke-opacity="0.3" />
        <circle cx="198" cy="652.5" r="7" fill="#0A0C18" fill-opacity="1" />
        <circle cx="198" cy="652.5" r="6.5" stroke="#F0F3F7" stroke-opacity="0.7" /><circle cx="958" cy="646.5" r="7" fill="#0A0C18" fill-opacity="1" />
        <circle cx="958" cy="646.5" r="6.5" stroke="#F0F3F7" stroke-opacity="0.7" />
      </svg>

    </div>
  );
};

export default AnimatedImage;
